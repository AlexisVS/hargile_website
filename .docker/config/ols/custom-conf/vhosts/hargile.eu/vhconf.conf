# Document root for the virtual host
docRoot                   $VH_ROOT
enableGzip                1
enableBr                  1

# Redirect HTTP to HTTPS
context / {
  type                    module
  location                HANDLER
  handler                 rewrite
  rewrite {
    RewriteCond %{HTTPS} !=on
    RewriteRule ^(.*)$ https://%{SERVER_NAME}$1 [R=301,L]
  }
}

# Next.js static files - serve directly for better performance
context /_next/static/ {
  location                $DOC_ROOT/.next/static/
  allowBrowse             1
  enableExpires           1
  expiresByType           text/css=A31536000, application/javascript=A31536000, image/*=A31536000
}

# Next.js Server - handle all other requests
context / {
  type                    appserver
  location                $DOC_ROOT
  binPath                 /usr/bin/node
  appType                 node
  startupFile             node_modules/.bin/next
  addDefaultCharset       off
  appserverEnv            NODE_ENV=production
  appserverEnv            PORT=3000
}

# Enable HTTP/3 (QUIC)
quicEnable               1

# Access Control
accessControl {
  allow                   ALL
}

# SSL Configuration
keyFile                   /ssl/privkey.pem
certFile                  /ssl/fullchain.pem
sslProtocol               24
enableECDHE               1
sslSessionCache           1
sslSessionTickets         1

# HSTS settings
rewrite {
  enable                  1
  rules                   <<<END_rules
  Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
  END_rules
}

# Enhanced Security Headers
context / {
  type                    module
  location                HANDLER
  handler                 general
  general {
    extraHeaders          <<<END_headers
    X-Frame-Options: SAMEORIGIN
    X-Content-Type-Options: nosniff
    X-XSS-Protection: 1; mode=block
    Referrer-Policy: strict-origin-when-cross-origin
    Permissions-Policy: camera=(), microphone=(), geolocation=()
    Content-Security-Policy: default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'self'; font-src 'self'; object-src 'none'; frame-ancestors 'self';
    END_headers
  }
}

# Cache optimization for static assets
expires {
  enableExpires           1
  expiresByType           image/*=A604800, text/css=A604800, application/javascript=A604800, application/x-javascript=A604800, application/woff=A604800, application/font-woff=A604800, font/*=A604800
}
