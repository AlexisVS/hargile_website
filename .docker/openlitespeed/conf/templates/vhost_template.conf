docRoot                   $VH_ROOT/html
enableGzip                1
enableBr                  1

# HTTP to HTTPS redirection
context / {
  type                    module
  location                HANDLER
  handler                 rewrite
  rewrite {
    RewriteCond %{HTTPS} !=on
    RewriteRule ^(.*)$ https://%{SERVER_NAME}$1 [R=301,L]
  }
}

# Reverse Proxy for Next.js
context / {
  type                    proxy
  handler                 nextjs
  addDefaultCharset       off
}

# Enable HTTP/3 (QUIC)
quicEnable               1

# Access control
accessControl {
  allow                   ALL
}

# SSL Configuration
keyFile                   /root/.acme.sh/$VH_NAME/privkey.pem
certFile                  /root/.acme.sh/$VH_NAME/fullchain.pem
sslProtocol               24
enableECDHE               1
sslSessionCache           1
sslSessionTickets         1

# HSTS settings
rewrite {
  enable                  1
  rules                   <<<END_rules
  Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
  END_rules
}

# Security headers
context / {
  type                    module
  location                HANDLER
  handler                 general
  general {
    extraHeaders          X-Frame-Options: SAMEORIGIN, X-Content-Type-Options: nosniff, X-XSS-Protection: 1; mode=block, Referrer-Policy: strict-origin-when-cross-origin
  }
}

# Cache optimization
expires {
  enableExpires           1
  expiresByType           image/*=A2592000, text/css=A2592000, application/javascript=A2592000, application/x-javascript=A2592000, application/woff=A2592000, application/font-woff=A2592000
}
